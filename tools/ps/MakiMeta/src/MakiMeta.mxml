<?xml version="1.0" encoding="utf-8"?>
<csxs:CSExtension xmlns:fx="http://ns.adobe.com/mxml/2009"
				  xmlns:s="library://ns.adobe.com/flex/spark"
				  xmlns:csxs="com.adobe.csxs.core.*"
				  close="csextension1_closeHandler(event)"
				  creationComplete="csextension1_creationCompleteHandler(event)"
				  showStatusBar="false">
	
	<fx:Script>
		<![CDATA[
			import com.adobe.csawlib.photoshop.Photoshop;
			import com.adobe.csxs.core.CSInterface;
			import com.adobe.csxs.core.CSXSInterface;
			import com.adobe.photoshop.*;
			import com.adobe.xmp.core.XMPMeta;
			
			import mx.controls.Alert;
			import mx.events.FlexEvent;
			
			private const SELECT:int = Photoshop.app.stringIDToTypeID("select");
			private const SELECT_STR:String = SELECT.toString();
			
			private const NULL:int = Photoshop.app.stringIDToTypeID("null");
			private const LAYER:int = Photoshop.app.stringIDToTypeID("layer");
			
			private var maki:Namespace = new Namespace("maki", "http://makiengine.com/");
			private var currentLayer:Layer = null;			
			
			protected function csextension1_creationCompleteHandler(event:FlexEvent):void
			{
				CSInterface.instance.autoThemeColorChange = true;
				
				// EXTRA SPECIAL NOTE OF PARAMOUNT IMPORTANCE:
				// CSXSInterface is deprecated, but evalScript("PhotoshopRegisterEvent"... doesn't work
				// with the newer CSInterface!
				try {
					CSXSInterface.instance.evalScript("PhotoshopRegisterEvent", SELECT.toString());
					ExternalInterface.addCallback("PhotoshopCallback" + extensionId, photoshopCallback);
				} catch(ex) {
					Alert.show(ex);
				}
				
				if(Photoshop.app.activeDocument != null) {
					currentLayer = Photoshop.app.activeDocument.activeLayer;
				}
				updateTextBox();
			}
			
			protected function csextension1_closeHandler(event:Event):void
			{
				saveData(currentLayer);
			}
			
			protected function applyButton_clickHandler(event:MouseEvent):void
			{
				saveData(currentLayer);
			}
			
			protected function metaTextArea_keyFocusChangeHandler(event:FocusEvent):void
			{
				// Prevent tab presses from switching focus
				event.preventDefault();
				event.target.insertText("\t");
			}
			
			private function photoshopCallback(eventID:Number, descID:Number):void
			{
				switch(eventID) {
					case SELECT:
						//Alert.show("descID: "+descID);
						var actionDesc:ActionDescriptor = new ActionDescriptor();
						var ref:ActionReference = actionDesc.getReference(NULL);
						var cls:int = ref.getDesiredClass();
						if(cls == LAYER) {
							layerSelectionChanged();
						}						
						break;
					default:
						break;
				}
			}
			
			private function updateTextBox():void
			{
				if(currentLayer != null) {
					metaTextArea.enabled = true;
					var xmp:XMPMeta = new XMPMeta(currentLayer.xmpMetadata.rawData);
					var s:String = xmp.maki::data;
					if(s != null) {
						metaTextArea.text = s;
					} else {
						metaTextArea.text = "";
					}
				} else {
					metaTextArea.enabled = false;
					metaTextArea.text = "";
				}
			}
			
			private function saveData(layer:Layer):void
			{
				if(layer != null) {
					var xmp:XMPMeta = new XMPMeta(layer.xmpMetadata.rawData);
					xmp.maki::data = metaTextArea.text;
					layer.xmpMetadata.rawData = new String(xmp.serializeToBuffer());
				}
			}
			
			private function layerSelectionChanged():void
			{
				// Save previously selected layer
				if(currentLayer != null) {
					saveData(currentLayer);
				}
				
				if(Photoshop.app.activeDocument != null) {
					currentLayer = Photoshop.app.activeDocument.activeLayer;
				}		
				updateTextBox();
			}
			
		]]>
	</fx:Script>
	<s:Group height="100%" width="100%">
		<s:Button id="applyButton" right="16" bottom="2" label="Apply" click="applyButton_clickHandler(event)"/>
		<s:TextArea id="metaTextArea" left="3" right="3" top="3" bottom="26"
					fontFamily="Courier New" horizontalScrollPolicy="auto"
					keyFocusChange="metaTextArea_keyFocusChangeHandler(event)" lineBreak="explicit"
					verticalScrollPolicy="auto"/>
	</s:Group>
</csxs:CSExtension>