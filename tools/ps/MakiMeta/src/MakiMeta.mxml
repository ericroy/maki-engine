<?xml version="1.0" encoding="utf-8"?>
<s:WindowedApplication xmlns:fx="http://ns.adobe.com/mxml/2009"
					   xmlns:s="library://ns.adobe.com/flex/spark"
					   xmlns:mx="library://ns.adobe.com/flex/mx"
					   height="360" close="windowedapplication1_closeHandler(event)"
					   creationComplete="windowedapplication1_creationCompleteHandler(event)"
					   focusIn="windowedapplication1_focusInHandler(event)"
					   focusOut="windowedapplication1_focusOutHandler(event)">
	<s:layout>
		<s:BasicLayout/>
	</s:layout>
	<fx:Script>
		<![CDATA[
			import com.adobe.csawlib.photoshop.Photoshop;
			import com.adobe.csxs.core.CSInterface;
			import com.adobe.photoshop.Layer;
			import com.adobe.xmp.core.XMPMeta;
			
			import mx.controls.Alert;
			import mx.events.FlexEvent;
			
			private const CURRENT_LAYER:int = Photoshop.app.charIDToTypeID("CrrL");
			
			private var maki:Namespace = new Namespace("maki", "http://makiengine.com/");
			private var currentLayer:Layer = null;			

			protected function windowedapplication1_creationCompleteHandler(event:FlexEvent):void
			{
				// We can provide comma delimited list of event ids if we want
				CSInterface.instance.evalScript("PhotoshopRegisterEvent", CURRENT_LAYER);
				
				ExternalInterface.addCallback("PhotoshopCallback", photoshopCallback);
				
				currentLayer = Photoshop.app.activeDocument.activeLayer;
				updateTextBox();
			}
			
			protected function applyButton_clickHandler(event:MouseEvent):void
			{
				Alert.show("Apply click");
				saveData(currentLayer);
			}
			
			
			protected function windowedapplication1_closeHandler(event:Event):void
			{
				saveData(currentLayer);
			}
			
			protected function windowedapplication1_focusInHandler(event:FocusEvent):void
			{
			}
			
			protected function windowedapplication1_focusOutHandler(event:FocusEvent):void
			{
			}
						
			private function updateTextBox():void
			{
				if(currentLayer != null) {
					var xmp:XMPMeta = new XMPMeta(currentLayer.xmpMetadata.rawData);
					metaTextArea.text = xmp.maki::data;
				} else {
					metaTextArea.text = "";
				}
			}
			
			private function saveData(layer:Layer):void
			{
				if(layer != null) {
					var xmp:XMPMeta = new XMPMeta(layer.xmpMetadata.rawData);
					xmp.maki::data = metaTextArea.text;
					layer.xmpMetadata.rawData = new String(xmp.serializeToBuffer());
				}
			}
			
			public function photoshopCallback(param1:Number, param2:Number):void
			{
				Alert.show("photoshop event");
				if(param1 == CURRENT_LAYER) {
					// Save previously selected layer
					if(currentLayer != null) {
						saveData(currentLayer);
					}
					currentLayer = Photoshop.app.activeDocument.activeLayer;		
					updateTextBox();
				}
			}

		]]>
	</fx:Script>
	<fx:Declarations>
		<!-- Place non-visual elements (e.g., services, value objects) here -->
	</fx:Declarations>
	<s:Button id="applyButton" right="12" bottom="14" label="Apply"
			  click="applyButton_clickHandler(event)"/>
	<s:TextArea id="metaTextArea" left="10" right="10" top="10" bottom="43"
				fontFamily="Courier New"/>
</s:WindowedApplication>
